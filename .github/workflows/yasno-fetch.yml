name: Fetch YASNO schedule (hourly)

on:
  schedule:
    - cron: "17 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch YASNO JSON
        run: |
          set -e
          curl -sSL "https://api.yasno.com.ua/api/v1/pages/home/schedule-turn-off-electricity" -o yasno_raw.json

      - name: Wrap with metadata
        run: |
          python - << 'PY'
          import json, datetime, os
          with open("yasno_raw.json", "r", encoding="utf-8") as f:
            payload = json.load(f)
          out = {
            "fetchedAt": datetime.datetime.now(datetime.timezone.utc).isoformat(),
            "source": "https://api.yasno.com.ua/api/v1/pages/home/schedule-turn-off-electricity",
            "payload": payload
          }
          os.makedirs("data", exist_ok=True)
          with open("data/yasno.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, separators=(",", ":"))
          PY

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/yasno.json
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "chore: update yasno schedule"
          git push
